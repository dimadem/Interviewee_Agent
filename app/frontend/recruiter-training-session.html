<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–µ—Ä –†–µ–∫—Ä—É—Ç–µ—Ä–∞ (CAAS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex flex-col justify-center items-center bg-[#2B2D33] min-h-screen font-sans">
    <div class="bg-white shadow mt-6 p-6 rounded w-full max-w-4xl">
        <div class="bg-gray-50 mb-4 p-2 rounded">
            <h2 class="mb-2 font-semibold text-lg">–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
            <div class="flex gap-4">
                <div class="flex-1">
                    <p class="font-medium text-gray-700 text-sm">–ü–æ–∑–∏—Ü–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</p>
                    <p id="positionDisplay" class="mt-1 text-sm">{{ position if position else "Not specified" }}</p>
                </div>
                <div class="flex-1">
                    <p class="font-medium text-gray-700 text-sm">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</p>
                    <p id="personalityDisplay" class="mt-1 text-sm">{{ personality if personality else "Not specified" }}</p>
                </div>
                <div class="flex-1">
                    <p class="font-medium text-gray-700 text-sm">–û–ø—ã—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</p>
                    <p id="experienceDisplay" class="mt-1 text-sm">{{ experience if experience else "Not specified" }}</p>
                </div>
                <div class="flex-1">
                    <p class="font-medium text-gray-700 text-sm">–ß–µ—Å—Ç–Ω–æ—Å—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</p>
                    <p id="honestyDisplay" class="mt-1 text-sm">{{ honesty if honesty else "Not specified" }}</p>
                </div>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
        <div id="connection-status" class="bg-yellow-100 mb-2 p-2 rounded text-yellow-700 text-center">
            –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
        </div>
        
        <!-- –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-spinner" class="hidden">
            <div class="flex items-center justify-center p-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <span class="ml-2 text-gray-600">–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>
            </div>
        </div>
        
        <div id="messages" class="mb-4 p-4 border h-80 overflow-y-auto"></div>
        <form id="chat-form" onsubmit="sendMessage(event)" class="flex space-x-2">
            <input type="text" id="messageText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" class="flex-grow p-2 border rounded" disabled>
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded text-white" disabled>
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </form>
        <div class="flex justify-between space-x-2 mt-4">
            <button id="endInterviewBtn" onclick="endInterview()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white">
                –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
            </button>
            <span id="recordingStatus" class="text-gray-600"></span>
            <button id="recordButton" onclick="toggleRecording()" class="bg-blue-600 hover:bg-red-600 px-4 py-2 rounded text-white" disabled>
                –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å
            </button>
        </div>
    </div>
    
    <script>
    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const currentPosition = urlParams.get('position');
    const currentPersonality = urlParams.get('personality');
    const currentExperience = urlParams.get('experience');
    const currentHonesty = urlParams.get('honesty');

    // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ñ–æ—Ä–º—É
    if (!currentPosition || !currentPersonality || !currentExperience || !currentHonesty) {
        window.location.href = '/recruiter-training';
    }

    // --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ---
    document.getElementById('positionDisplay').textContent = currentPosition;
    document.getElementById('personalityDisplay').textContent = currentPersonality;
    document.getElementById('experienceDisplay').textContent = currentExperience;
    document.getElementById('honestyDisplay').textContent = currentHonesty;

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let isConnected = false;
    let isWaitingForResponse = false;
    let ws;

    // --- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –∏–Ω—Ç–µ—Ä–≤—å—é ---
    const style_instructions = {
        "structured": "–ü—Ä–æ–≤–æ–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ, –∑–∞–¥–∞–≤–∞—è –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ. –§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è—Ö –∏ –æ–ø—ã—Ç–µ.",
        "behavioral": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞...'. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.",
        "situational": "–ó–∞–¥–∞–≤–∞–π—Ç–µ –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –≤–∏–¥–∞ '–ß—Ç–æ –±—ã –≤—ã —Å–¥–µ–ª–∞–ª–∏, –µ—Å–ª–∏...'. –û—Ü–µ–Ω–∏–≤–∞–π—Ç–µ –ø–æ–¥—Ö–æ–¥ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∫ —Ä–µ—à–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º.",
        "stress": "–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —É–º–µ—Ä–µ–Ω–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. –û—Ü–µ–Ω–∏–≤–∞–π—Ç–µ —Å—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å."
    };

    // --- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π ---
    const competency_instructions = {
        "technical": "–§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö, –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º –∏ —Ä–µ—à–µ–Ω–∏—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á.",
        "soft": "–û—Ü–µ–Ω–∏–≤–∞–π—Ç–µ soft skills: –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é, —Ä–∞–±–æ—Ç—É –≤ –∫–æ–º–∞–Ω–¥–µ, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å. –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ –º–µ–∂–ª–∏—á–Ω–æ—Å—Ç–Ω–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏.",
        "leadership": "–ò—Å—Å–ª–µ–¥—É–π—Ç–µ –ª–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞: –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π, –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–æ—Ç–∏–≤–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥—ã.",
        "problem_solving": "–§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–º –º—ã—à–ª–µ–Ω–∏–∏ –∏ –ø–æ–¥—Ö–æ–¥–µ –∫ —Ä–µ—à–µ–Ω–∏—é —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á.",
        "communication": "–û—Ü–µ–Ω–∏–≤–∞–π—Ç–µ –Ω–∞–≤—ã–∫–∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: —á–µ—Ç–∫–æ—Å—Ç—å –∏–∑–ª–æ–∂–µ–Ω–∏—è, —É–º–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç—å, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–∏."
    };

    // --- –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ---
    const conversationHistory = {
        timestamp: new Date().toISOString(),
        position: currentPosition,
        personality: currentPersonality,
        experience: currentExperience,
        honesty: currentHonesty,
        random_profile: null,  // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
        messages: []
    };

    // --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ---
    function connectWebSocket() {
        let wsHost = window.location.host;
        if (!wsHost || wsHost === 'false') wsHost = 'localhost:8000';
        const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
        const wsUrl = `${wsProtocol}://${wsHost}/ws/recruiter-training?position=${encodeURIComponent(currentPosition)}&personality=${encodeURIComponent(currentPersonality)}&experience=${encodeURIComponent(currentExperience)}&honesty=${encodeURIComponent(currentHonesty)}`;
        
        ws = new WebSocket(wsUrl);
        updateConnectionStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'yellow');
        
        ws.onopen = () => {
            isConnected = true;
            updateConnectionStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'green');
            enableInterface();
        };
        
        ws.onclose = (event) => {
            isConnected = false;
            disableInterface();
            if (event.code === 1000) {
                updateConnectionStatus('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'yellow');
            } else {
                updateConnectionStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'red');
            }
        };
        
        ws.onerror = (error) => {
            updateConnectionStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'red');
        };
        
        ws.onmessage = handleWebSocketMessage;
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏–Ω–Ω–µ—Ä–æ–º ---
    function showLoadingSpinner() {
        document.getElementById('loading-spinner').classList.remove('hidden');
    }

    function hideLoadingSpinner() {
        document.getElementById('loading-spinner').classList.add('hidden');
    }

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ---
    function handleWebSocketMessage(event) {
        try {
            const response = JSON.parse(event.data);
            if (response.type === 'error') {
                showError(`–û—à–∏–±–∫–∞: ${response.text}`);
                resetWaitingState();
                return;
            }
            if (['text', 'voice'].includes(response.type)) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ random_profile –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                if (response.random_profile && !conversationHistory.random_profile) {
                    conversationHistory.random_profile = response.random_profile;
                }
                processMessage(response);
                updateChatDisplay();
                hideStatusMessage();
                resetWaitingState();
                hideLoadingSpinner();  // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
            }
        } catch {
            showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            resetWaitingState();
            hideLoadingSpinner();  // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        }
    }

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ ---
    function processMessage(response) {
        if (response.type === 'voice' && response.user_text) addUserMessage(response.user_text);
        if (response.content && response.content.trim()) {
            addAssistantMessage(response.content);
            if (response.type === 'voice' && response.audio) {
                hideStatusMessage();
                playAudio(response.audio);
            }
        }
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ ---
    function addUserMessage(content) {
        const lastUserMessage = getLastMessageByRole('user');
        if (!lastUserMessage || lastUserMessage.content !== content) {
            conversationHistory.messages.push({ role: "user", content });
        }
    }

    function addAssistantMessage(content) {
        const lastAssistantMessage = getLastMessageByRole('assistant');
        if (!lastAssistantMessage || lastAssistantMessage.content !== content) {
            conversationHistory.messages.push({ role: "assistant", content });
        }
    }

    function getLastMessageByRole(role) {
        return conversationHistory.messages.filter(msg => msg.role === role).pop();
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
    function resetWaitingState() {
        isWaitingForResponse = false;
        enableInterface();
        hideLoadingSpinner();  // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è
    }

    function hideStatusMessage() {
        updateConnectionStatus('', '');
    }

    function updateConnectionStatus(message, color) {
        const statusElement = document.getElementById('connection-status');
        statusElement.textContent = message;
        if (color === 'green') {
            statusElement.className = 'mb-2 p-2 text-center rounded bg-green-100 text-green-700';
        } else if (color === 'yellow') {
            statusElement.className = 'mb-2 p-2 text-center rounded bg-yellow-100 text-yellow-700';
        } else if (color === 'red') {
            statusElement.className = 'mb-2 p-2 text-center rounded bg-red-100 text-red-700';
        }
    }

    function showError(message) {
        const statusElement = document.getElementById('connection-status');
        statusElement.textContent = message;
        statusElement.className = 'mb-2 p-2 text-center rounded bg-red-100 text-red-700';
        statusElement.classList.remove('hidden');
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º ---
    function enableInterface() {
        document.getElementById('messageText').disabled = false;
        document.querySelector('#chat-form button').disabled = false;
        document.getElementById('recordButton').disabled = false;
    }

    function disableInterface() {
        document.getElementById('messageText').disabled = true;
        document.querySelector('#chat-form button').disabled = true;
        document.getElementById('recordButton').disabled = true;
    }

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
    function sendMessage(event) {
        event.preventDefault();
        if (!isConnected || isWaitingForResponse) return;
        
        const input = document.getElementById("messageText");
        const message = input.value.trim();
        if (message === "") return;

        addUserMessage(message);
        updateChatDisplay();
        
        showLoadingSpinner();  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        ws.send(JSON.stringify({
            type: 'text',
            content: message
        }));

        input.value = '';
        isWaitingForResponse = true;
        disableInterface();
    }

    // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ ---
    function updateChatDisplay() {
        const messagesEl = document.getElementById('messages');
        messagesEl.innerHTML = "";
        conversationHistory.messages.forEach(msg => {
            const div = document.createElement('div');
            if (msg.role === 'user') {
                div.textContent = 'Ôºªüë§ÔºΩ: ' + msg.content;
                div.className = 'mb-2 text-right';
            } else if (msg.role === 'assistant') {
                div.textContent = 'Ôºªü§ñÔºΩ: ' + msg.content;
                div.className = 'mb-2 text-left';
            }
            messagesEl.appendChild(div);
        });
        scrollChatToBottom();
    }

    function scrollChatToBottom() {
        const messagesEl = document.getElementById('messages');
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // --- –ó–∞–ø–∏—Å—å –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ ---
    async function setupAudioRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                showLoadingSpinner();  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å–∏
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const reader = new FileReader();
                
                reader.onload = () => {
                    const base64Audio = reader.result.split(',')[1];
                    ws.send(JSON.stringify({
                        type: 'voice',
                        audio: base64Audio
                    }));
                };
                
                reader.readAsDataURL(audioBlob);
                audioChunks = [];
                isWaitingForResponse = true;
                disableInterface();
            };
        } catch (error) {
            console.error('Error accessing microphone:', error);
            document.getElementById('recordButton').disabled = true;
        }
    }

    function toggleRecording() {
        if (!isRecording) {
            mediaRecorder.start();
            isRecording = true;
            document.getElementById('recordButton').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
            document.getElementById('recordButton').classList.add('bg-red-600');
            document.getElementById('recordingStatus').textContent = '–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...';
        } else {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById('recordButton').textContent = '–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å';
            document.getElementById('recordButton').classList.remove('bg-red-600');
            document.getElementById('recordingStatus').textContent = '';
        }
    }

    function playAudio(base64Audio) {
        const audio = new Audio(`data:audio/wav;base64,${base64Audio}`);
        audio.play();
    }

    // --- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ---
    function endInterview() {
        if (!conversationHistory.messages.length) {
            alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.");
            return;
        }
        
        if (!confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?")) return;
        
        try {
            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            exportInterviewData();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "end_session",
                    ...conversationHistory  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é, –≤–∫–ª—é—á–∞—è random_profile
                }));
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                ws.close(1000, 'Session ended by user');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
                updateConnectionStatus('–°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'green');
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                disableInterface();
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: ' + error.message);
        }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö ---
    function exportInterviewData() {
        const trainingData = {
            ...conversationHistory  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ conversationHistory, –≤–∫–ª—é—á–∞—è random_profile
        };

        if (!trainingData.messages.length) {
            throw new Error("–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }

        const jsonData = JSON.stringify(trainingData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const fileName = generateFileName(currentPosition);
        downloadBlob(blob, fileName);
    }

    function generateFileName(position) {
        const sanitizedPosition = position.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, '_').substring(0, 20);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        return `recruiter_training_${sanitizedPosition}_${timestamp}.json`;
    }

    function downloadBlob(blob, fileName) {
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.download = fileName;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(downloadLink.href);
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    setupAudioRecording();
    connectWebSocket();
    </script>
</body>
</html> 